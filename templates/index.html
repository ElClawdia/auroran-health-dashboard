<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶û Auroran Health Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --card-bg: #161b22;
            --border: #30363d;
            --primary: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --text: #c9d1d9;
            --text-dim: #8b949e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h1 .emoji {
            font-size: 2rem;
        }
        
        .subtitle {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-top: 4px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .account-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dim);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
        }
        
        .account-link:hover {
            background: var(--card-bg);
            color: var(--primary);
        }
        
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        .card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }
        
        .card-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background 0.2s, color 0.2s;
            opacity: 0;
        }
        
        .card:hover .card-action-btn {
            opacity: 1;
        }
        
        .card-action-btn:hover {
            background: var(--border);
            color: var(--primary);
        }
        
        .card-action-btn.active {
            opacity: 1;
            color: var(--primary);
        }
        
        .card-action-btn.refresh-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            top: auto;
        }
        
        .card-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .card-value.editing {
            display: none;
        }
        
        .card-input {
            display: none;
            width: 100%;
            font-size: 1.8rem;
            font-weight: 600;
            background: var(--bg);
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: var(--text);
            padding: 4px 8px;
            margin-bottom: 4px;
        }
        
        .card-input.editing {
            display: block;
        }
        
        .card.manual-value .card-value::after {
            content: ' ‚úé';
            font-size: 0.6em;
            color: var(--warning);
        }
        
        .card-trend {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .trend-neutral { color: var(--text-dim); }
        
        .chart-card {
            grid-column: 1 / -1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: var(--text);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .chart-container-pmc {
            position: relative;
            height: 350px;
        }
        
        .recommendation-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #1a2332 100%);
            border: 1px solid var(--primary);
        }
        
        .recovery-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 12px;
        }
        
        .recovery-high { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .recovery-moderate { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .recovery-easy { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .recovery-rest { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
        
        .workout-recommendation {
            margin-top: 16px;
        }
        
        .workout-type {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .workout-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .workout-detail {
            background: rgba(88, 166, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .workout-detail-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .workout-detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .alternatives {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .alternatives h4 {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        
        .alt-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
        }
        
        .tips {
            margin-top: 12px;
            padding: 12px;
            background: rgba(88, 166, 255, 0.05);
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .tips li {
            margin-left: 16px;
            margin-bottom: 4px;
            color: var(--text-dim);
        }
        
        .weekly-plan {
            grid-column: 1 / -1;
        }
        
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 16px;
        }
        
        .day-card {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .day-name {
            color: var(--text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .day-type {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .day-duration {
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        
        .day-rest {
            color: var(--danger);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--text-dim);
        }
        
        .error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            header h1 {
                font-size: 1.2rem;
            }
            
            .week-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                padding: 12px;
            }
            
            .workout-header {
                display: none !important;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><span class="emoji">ü¶û</span> Auroran Health Command Center</h1>
                <div class="subtitle">Personal AI Health Dashboard ‚Ä¢ Training Hub</div>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div id="last-updated" style="color: var(--text-dim); font-size: 0.85rem;">
                    Loading...
                </div>
                <a href="/account" class="account-link" title="Account Settings">
                    <span style="font-size: 1.2rem;">üë§</span>
                    <span>{{ user.full_name if user else 'Account' }}</span>
                </a>
            </div>
        </header>
        
        <div id="error-container"></div>
        
        <!-- Today's Stats -->
        <div class="grid">
            <div class="card editable-card" data-metric="sleep">
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit value">‚úé</button>
                </div>
                <button class="card-action-btn refresh-btn" title="Use automated value">‚Üª</button>
                <div class="card-label">üí§ Sleep</div>
                <div class="card-value" id="sleep-value">--</div>
                <input type="number" step="0.1" class="card-input" id="sleep-input" placeholder="Hours">
                <div class="card-trend" id="sleep-trend"></div>
            </div>
            <div class="card editable-card" data-metric="hrv">
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit value">‚úé</button>
                </div>
                <button class="card-action-btn refresh-btn" title="Use automated value">‚Üª</button>
                <div class="card-label">‚ù§Ô∏è HRV</div>
                <div class="card-value" id="hrv-value">--</div>
                <input type="number" step="1" class="card-input" id="hrv-input" placeholder="ms">
                <div class="card-trend" id="hrv-trend"></div>
            </div>
            <div class="card editable-card" data-metric="resting_hr">
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit value">‚úé</button>
                </div>
                <button class="card-action-btn refresh-btn" title="Use automated value">‚Üª</button>
                <div class="card-label">ü´Ä Resting HR</div>
                <div class="card-value" id="rhr-value">--</div>
                <input type="number" step="1" class="card-input" id="rhr-input" placeholder="bpm">
                <div class="card-trend" id="rhr-trend"></div>
            </div>
            <div class="card editable-card" data-metric="steps">
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit value">‚úé</button>
                </div>
                <button class="card-action-btn refresh-btn" title="Use automated value">‚Üª</button>
                <div class="card-label">üëü Steps</div>
                <div class="card-value" id="steps-value">--</div>
                <input type="number" step="100" class="card-input" id="steps-input" placeholder="Steps">
                <div class="card-trend" id="steps-trend"></div>
            </div>
        </div>
        
        <!-- Weight & Calories -->
        <div class="grid">
            <div class="card editable-card" data-metric="weight">
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit value">‚úé</button>
                </div>
                <button class="card-action-btn refresh-btn" title="Use automated value">‚Üª</button>
                <div class="card-label">‚öñÔ∏è Weight</div>
                <div class="card-value" id="weight-value">--</div>
                <input type="number" step="0.1" class="card-input" id="weight-input" placeholder="kg">
                <div class="card-trend" id="weight-trend"></div>
            </div>
            <div class="card">
                <div class="card-label">üî• Calories Burned</div>
                <div class="card-value" id="calories-value">--</div>
                <div class="card-trend" id="calories-trend" style="color: var(--text-dim);">From workouts</div>
            </div>
        </div>
        
        <!-- PMC / Training Load -->
        <div class="grid">
            <div class="card editable-card" data-metric="ctl" style="border-color: var(--primary);">
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit value">‚úé</button>
                </div>
                <button class="card-action-btn refresh-btn" title="Use automated value">‚Üª</button>
                <div class="card-label">üí™ CTL (Fitness)</div>
                <div class="card-value" id="ctl-value">--</div>
                <input type="number" step="0.1" class="card-input" id="ctl-input" placeholder="CTL">
                <div class="card-trend" style="color: var(--text-dim);">42-day avg</div>
            </div>
            <div class="card editable-card" data-metric="atl" style="border-color: var(--warning);">
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit value">‚úé</button>
                </div>
                <button class="card-action-btn refresh-btn" title="Use automated value">‚Üª</button>
                <div class="card-label">üî• ATL (Strain)</div>
                <div class="card-value" id="atl-value">--</div>
                <input type="number" step="0.1" class="card-input" id="atl-input" placeholder="ATL">
                <div class="card-trend" style="color: var(--text-dim);">7-day avg</div>
            </div>
            <div class="card editable-card" data-metric="tsb" id="tsb-card">
                <div class="card-actions">
                    <button class="card-action-btn edit-btn" title="Edit value">‚úé</button>
                </div>
                <button class="card-action-btn refresh-btn" title="Use automated value">‚Üª</button>
                <div class="card-label">‚öñÔ∏è TSB (Form)</div>
                <div class="card-value" id="tsb-value">--</div>
                <input type="number" step="0.1" class="card-input" id="tsb-input" placeholder="TSB">
                <div class="card-trend" id="tsb-status">Loading...</div>
            </div>
        </div>
        
        <!-- PMC 30-day Chart -->
        <div class="chart-card">
            <div class="chart-title">üìä PMC - Performance Management (30-Day)</div>
            <div class="chart-container-pmc">
                <canvas id="pmcChart"></canvas>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-card">
            <div class="chart-title">üìà 30-Day Health Trends</div>
            <div class="chart-container">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>
        
        <!-- Today's Recommendation -->
        <div class="grid">
            <div class="card recommendation-card" style="grid-column: span 2;">
                <div class="card-label">üéØ Today's Recommendation</div>
                <div id="recovery-badge" class="recovery-badge recovery-high">RECOVERY: --%</div>
                <p id="recommendation-message" style="color: var(--text); margin-bottom: 16px;">
                    Loading your personalized recommendation...
                </p>
                
                <div id="workout-section" class="workout-recommendation">
                    <div class="workout-type" id="workout-type">--</div>
                    <div class="workout-details">
                        <div class="workout-detail">
                            <div class="workout-detail-label">Duration</div>
                            <div class="workout-detail-value" id="workout-duration">--</div>
                        </div>
                        <div class="workout-detail">
                            <div class="workout-detail-label">Zone</div>
                            <div class="workout-detail-value" id="workout-zone">--</div>
                        </div>
                        <div class="workout-detail">
                            <div class="workout-detail-label">Intensity</div>
                            <div class="workout-detail-value" id="workout-intensity">--</div>
                        </div>
                        <div class="workout-detail">
                            <div class="workout-detail-label">Pace</div>
                            <div class="workout-detail-value" id="workout-pace">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="alternatives">
                    <h4>Alternatives</h4>
                    <div id="alternatives-list"></div>
                </div>
                
                <div class="tips">
                    <ul id="tips-list"></ul>
                </div>
            </div>
            
            <!-- Weekly Summary -->
            <div class="card recommendation-card">
                <div class="card-label">üìÖ This Week</div>
                <div id="weekly-status" style="font-size: 1.2rem; font-weight: 600; color: var(--success);">
                    --
                </div>
                <div id="weekly-details" style="margin-top: 12px; font-size: 0.9rem; color: var(--text-dim);">
                    --
                </div>
            </div>
        </div>
        
        <!-- Weekly Plan -->
        <div class="chart-card weekly-plan">
            <div class="chart-title">üóìÔ∏è This Week's Training Plan</div>
            <div class="week-grid" id="week-plan">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Recent Workouts -->
        <div class="chart-card">
            <div class="chart-title">üèÉ Recent Workouts</div>
            <div id="workouts-list">
                <div class="loading">Loading workouts...</div>
            </div>
        </div>
    </div>
    
    <script>
        // Chart configuration
        let trendsChart = null;
        let pmcChart = null;
        
        async function fetchData() {
            try {
                // Fetch today's health
                const healthRes = await fetch('/api/health/today');
                const health = await healthRes.json();
                updateHealthCards(health);
                
                // Fetch history
                const historyRes = await fetch('/api/health/history?days=30');
                const history = await historyRes.json();
                updateChart(history);
                
                // Fetch recommendation
                const recRes = await fetch('/api/recommendations/today');
                const recommendation = await recRes.json();
                updateRecommendation(recommendation);
                
                // Fetch PMC (Training Load)
                const pmcRes = await fetch('/api/pmc?days=30');
                const pmc = await pmcRes.json();
                updatePMC(pmc);
                
                // Fetch weekly plan
                const weekPlan = recommendation.alternatives ? generateWeekPlan(recommendation) : [];
                updateWeekPlan(weekPlan);
                
                // Fetch workouts
                const workoutsRes = await fetch('/api/workouts');
                const workouts = await workoutsRes.json();
                updateWorkouts(workouts);
                
                // Fetch calories
                const caloriesRes = await fetch('/api/calories');
                const caloriesData = await caloriesRes.json();
                updateCalories(caloriesData);
                
                // Fetch weight
                const weightRes = await fetch('/api/weight');
                const weightData = await weightRes.json();
                updateWeight(weightData);
                
                // Update timestamp
                document.getElementById('last-updated').textContent = 
                    'Updated: ' + new Date().toLocaleTimeString();
                    
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('error-container').innerHTML = 
                    `<div class="error">Error loading data: ${error.message}</div>`;
            }
        }
        
        function updateCalories(data) {
            const el = document.getElementById('calories-value');
            if (el && data.calories) {
                el.textContent = data.calories.toLocaleString() + ' kcal';
            } else if (el) {
                el.textContent = '--';
            }
        }
        
        function updateWeight(data) {
            const el = document.getElementById('weight-value');
            if (el && data.weight) {
                el.textContent = data.weight.toFixed(1) + ' kg';
                // Mark as manual if from manual source
                const card = el.closest('.editable-card');
                if (card && data.source === 'manual') {
                    card.classList.add('manual-value');
                }
            } else if (el) {
                el.textContent = '--';
            }
        }
        
        function updateHealthCards(data) {
            document.getElementById('sleep-value').textContent = data.sleep_hours ? data.sleep_hours.toFixed(1) + 'h' : '--';
            document.getElementById('hrv-value').textContent = data.hrv ? data.hrv + ' ms' : '--';
            document.getElementById('rhr-value').textContent = data.resting_hr ? data.resting_hr + ' bpm' : '--';
            document.getElementById('steps-value').textContent = data.steps ? data.steps.toLocaleString() : '--';
            
            if (data.trend) {
                document.getElementById('sleep-trend').innerHTML = formatTrend(data.trend.sleep, 'sleep');
                document.getElementById('hrv-trend').innerHTML = formatTrend(data.trend.hrv, 'hrv');
                document.getElementById('rhr-trend').innerHTML = formatTrend(data.trend.resting_hr, 'rhr');
            }
        }
        
        function formatTrend(value, type) {
            if (!value) return '';
            let cls = 'trend-neutral';
            if (type === 'hrv' || type === 'sleep') {
                cls = value.includes('+') ? 'trend-up' : (value.includes('-') ? 'trend-down' : 'trend-neutral');
            } else if (type === 'rhr') {
                cls = value.includes('-') ? 'trend-up' : (value.includes('+') ? 'trend-down' : 'trend-neutral');
            }
            return `<span class="${cls}">${value}</span>`;
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            const dates = (data.dates || []).slice(-30);
            const hrv = (data.hrv || []).slice(-30);
            const restingHr = (data.resting_hr || []).slice(-30);
            const sleep = (data.sleep || []).slice(-30);
            const steps = (data.steps || []).slice(-30);

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.slice(5)),
                    datasets: [
                        {
                            label: 'HRV (ms)',
                            data: hrv,
                            borderColor: '#3fb950',
                            backgroundColor: 'rgba(63, 185, 80, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Resting HR (bpm)',
                            data: restingHr,
                            borderColor: '#f85149',
                            backgroundColor: 'rgba(248, 81, 73, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Sleep (h)',
                            data: sleep,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y2'
                        },
                        {
                            label: 'Steps',
                            data: steps,
                            borderColor: '#a371f7',
                            backgroundColor: 'rgba(163, 113, 247, 0.1)',
                            fill: false,
                            tension: 0.35,
                            yAxisID: 'y3'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#3fb950' },
                            grid: { color: '#30363d' },
                            title: { display: true, text: 'HRV (ms)', color: '#3fb950' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#f85149' },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'HR (bpm)', color: '#f85149' }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#58a6ff', callback: v => v + 'h' },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Sleep (h)', color: '#58a6ff' }
                        },
                        y3: {
                            type: 'linear',
                            position: 'right',
                            offset: true,
                            ticks: { color: '#a371f7', callback: v => Number(v).toLocaleString() },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Steps', color: '#a371f7' }
                        }
                    }
                }
            });
        }
        
        function updateRecommendation(data) {
            const badge = document.getElementById('recovery-badge');
            badge.textContent = `RECOVERY: ${data.recovery}%`;
            
            badge.className = 'recovery-badge';
            if (data.recommendation === 'HIGH') {
                badge.classList.add('recovery-high');
            } else if (data.recommendation === 'MODERATE') {
                badge.classList.add('recovery-moderate');
            } else if (data.recommendation === 'EASY') {
                badge.classList.add('recovery-easy');
            } else {
                badge.classList.add('recovery-rest');
            }
            
            document.getElementById('recommendation-message').textContent = data.message;
            
            if (data.workout) {
                document.getElementById('workout-type').textContent = data.workout.type || '--';
                document.getElementById('workout-duration').textContent = data.workout.duration ? data.workout.duration + ' min' : '--';
                document.getElementById('workout-zone').textContent = data.workout.zone || '--';
                document.getElementById('workout-intensity').textContent = data.workout.intensity || '--';
                document.getElementById('workout-pace').textContent = data.workout.pace || '--';
            } else {
                document.getElementById('workout-section').style.display = 'none';
            }
            
            // Alternatives
            const altList = document.getElementById('alternatives-list');
            altList.innerHTML = '';
            if (data.alternatives) {
                data.alternatives.forEach(alt => {
                    altList.innerHTML += `
                        <div class="alt-item">
                            <span>${alt.type}</span>
                            <span style="color: var(--text-dim);">${alt.duration} min</span>
                        </div>
                    `;
                });
            }
            
            // Tips
            const tipsList = document.getElementById('tips-list');
            tipsList.innerHTML = '';
            if (data.tips) {
                data.tips.forEach(tip => {
                    tipsList.innerHTML += `<li>${tip}</li>`;
                });
            }
            
            // Weekly status
            document.getElementById('weekly-status').textContent = data.recommendation;
            document.getElementById('weekly-details').textContent = 
                data.recommendation === 'HIGH' ? 'Great week to push volume!' :
                data.recommendation === 'MODERATE' ? 'Build steadily this week' :
                data.recommendation === 'EASY' ? 'Focus on recovery this week' :
                'Rest is essential';
        }
        
        function updatePMC(data) {
            // CTL (Fitness) - 42 day average
            document.getElementById('ctl-value').textContent = data.ctl || '--';
            
            // ATL (Strain) - 7 day average
            document.getElementById('atl-value').textContent = data.atl || '--';
            
            // TSB (Form) = CTL - ATL
            const tsbCard = document.getElementById('tsb-card');
            const tsbValue = document.getElementById('tsb-value');
            const tsbStatus = document.getElementById('tsb-status');
            
            if (data.tsb !== undefined) {
                const tsb = data.tsb;
                tsbValue.textContent = tsb > 0 ? '+' + tsb : tsb;
                
                // Color code based on TSB
                if (tsb > 10) {
                    tsbCard.style.borderColor = '#3fb950'; // Green - fresh
                    tsbStatus.innerHTML = '<span style="color: #3fb950;">' + data.status + '</span>';
                } else if (tsb > -10) {
                    tsbCard.style.borderColor = '#d29922'; // Yellow - balanced
                    tsbStatus.innerHTML = '<span style="color: #d29922;">' + data.status + '</span>';
                } else {
                    tsbCard.style.borderColor = '#f85149'; // Red - fatigued
                    tsbStatus.innerHTML = '<span style="color: #f85149;">' + data.status + '</span>';
                }
            } else {
                tsbValue.textContent = '--';
                tsbStatus.textContent = 'No data';
            }

            updatePMCChart(data.chart || {});
        }

        function updatePMCChart(chart) {
            const canvas = document.getElementById('pmcChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            if (pmcChart) {
                pmcChart.destroy();
            }

            const dates = (chart.dates || []).slice(-30);
            const ctl = (chart.ctl || []).slice(-30);
            const atl = (chart.atl || []).slice(-30);
            const tsb = (chart.tsb || []).slice(-30);

            // Calculate appropriate Y-axis range based on data
            const allCtlAtl = [...ctl, ...atl].filter(v => v != null);
            const allTsb = tsb.filter(v => v != null);
            
            // For CTL/ATL: add padding to make 10-point changes visible
            const ctlAtlMin = Math.min(...allCtlAtl);
            const ctlAtlMax = Math.max(...allCtlAtl);
            const ctlAtlRange = ctlAtlMax - ctlAtlMin;
            const ctlAtlPadding = Math.max(10, ctlAtlRange * 0.15);
            const yMin = Math.max(0, Math.floor((ctlAtlMin - ctlAtlPadding) / 10) * 10);
            const yMax = Math.ceil((ctlAtlMax + ctlAtlPadding) / 10) * 10;
            
            // For TSB: separate scale since it can go negative
            const tsbMin = Math.min(...allTsb);
            const tsbMax = Math.max(...allTsb);
            const tsbPadding = Math.max(5, (tsbMax - tsbMin) * 0.15);
            const y2Min = Math.floor((tsbMin - tsbPadding) / 10) * 10;
            const y2Max = Math.ceil((tsbMax + tsbPadding) / 10) * 10;

            pmcChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.slice(5)),
                    datasets: [
                        {
                            label: 'CTL (Fitness)',
                            data: ctl,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.35,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'ATL (Strain)',
                            data: atl,
                            borderColor: '#d29922',
                            backgroundColor: 'rgba(210, 153, 34, 0.1)',
                            borderWidth: 2,
                            tension: 0.35,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'TSB (Form)',
                            data: tsb,
                            borderColor: '#3fb950',
                            backgroundColor: 'rgba(63, 185, 80, 0.1)',
                            borderWidth: 2,
                            tension: 0.35,
                            fill: false,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            min: yMin,
                            max: yMax,
                            ticks: { 
                                color: '#c9d1d9',
                                stepSize: 10
                            },
                            grid: { color: '#30363d' },
                            title: { display: true, text: 'CTL / ATL', color: '#8b949e' }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            min: y2Min,
                            max: y2Max,
                            ticks: { 
                                color: '#3fb950',
                                stepSize: 10
                            },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'TSB (Form)', color: '#3fb950' }
                        }
                    }
                }
            });
        }
        
        function generateWeekPlan(recommendation) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const plan = [];
            
            // Generate based on recommendation
            if (recommendation.recommendation === 'HIGH') {
                plan.push({day: 'Mon', type: 'Intervals', duration: 45});
                plan.push({day: 'Tue', type: 'Easy Run', duration: 35});
                plan.push({day: 'Wed', type: 'Strength', duration: 45});
                plan.push({day: 'Thu', type: 'Tempo', duration: 40});
                plan.push({day: 'Fri', type: 'Rest', duration: 0});
                plan.push({day: 'Sat', type: 'Long Run', duration: 75});
                plan.push({day: 'Sun', type: 'Rest', duration: 0});
            } else if (recommendation.recommendation === 'MODERATE') {
                plan.push({day: 'Mon', type: 'Easy Run', duration: 40});
                plan.push({day: 'Tue', type: 'Strength', duration: 45});
                plan.push({day: 'Wed', type: 'Rest', duration: 0});
                plan.push({day: 'Thu', type: 'Tempo', duration: 35});
                plan.push({day: 'Fri', type: 'Rest', duration: 0});
                plan.push({day: 'Sat', type: 'Long Run', duration: 50});
                plan.push({day: 'Sun', type: 'Rest', duration: 0});
            } else {
                plan.push({day: 'Mon', type: 'Rest', duration: 0});
                plan.push({day: 'Tue', type: 'Easy', duration: 25});
                plan.push({day: 'Wed', type: 'Rest', duration: 0});
                plan.push({day: 'Thu', type: 'Easy', duration: 25});
                plan.push({day: 'Fri', type: 'Rest', duration: 0});
                plan.push({day: 'Sat', type: 'Walk', duration: 30});
                plan.push({day: 'Sun', type: 'Rest', duration: 0});
            }
            
            return plan;
        }
        
        function updateWeekPlan(plan) {
            const container = document.getElementById('week-plan');
            container.innerHTML = '';
            
            plan.forEach(day => {
                const isRest = day.type === 'Rest';
                container.innerHTML += `
                    <div class="day-card">
                        <div class="day-name">${day.day}</div>
                        <div class="day-type ${isRest ? 'day-rest' : ''}">${day.type}</div>
                        <div class="day-duration">${isRest ? 'Rest' : day.duration + ' min'}</div>
                    </div>
                `;
            });
        }
        
        function updateWorkouts(workouts) {
            const container = document.getElementById('workouts-list');
            
            if (!workouts || workouts.length === 0) {
                container.innerHTML = '<div class="loading">No workouts yet. Add your first workout!</div>';
                return;
            }
            
            // Header row - right align to match data
            let html = `<div class="workout-header" style="display: none; padding: 8px 12px; 
                        border-bottom: 2px solid var(--border); color: var(--text-dim); font-size: 11px; font-weight: 600;">
                        <span>WORKOUT</span>
                        <span>min ‚Üëm ‚ö°EFFORT bpm</span>
                    </div>`;
            
            workouts.slice(0, 10).forEach(w => {
                const isSwimming = w.type && w.type.toLowerCase().includes('swim');
                const distance = w.distance ? (isSwimming ? Math.round(w.distance) + 'm' : (w.distance / 1000).toFixed(1) + 'km') : '';
                const elevation = w.elevation_gain ? Math.round(w.elevation_gain) + 'm' : '';
                const effort = w.suffer_score ? Math.round(w.suffer_score) : '';
                const hr = w.avg_hr ? Math.round(w.avg_hr) : '';
                const time = w.time ? w.time : (w.start_time ? w.start_time : '');
                const name = w.name ? w.name : w.type;
                
                const dur = (w.duration || w.duration_minutes || '--') + ' min';
                const elev = elevation ? '‚Üë' + elevation : '';
                const eff = effort ? '‚ö°' + effort : '';
                const heart = hr ? hr + ' bpm' : '';
                
                // Mobile-friendly card layout
                const stravaUrl = w.strava_id ? `https://www.strava.com/activities/${w.strava_id}` : '';
                const workoutLink = stravaUrl ? `<a href="${stravaUrl}" target="_blank" rel="noopener" style="color: inherit; text-decoration: none;">${name}</a>` : name;
                
                html += `
                    <div style="padding: 12px; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 4px;">
                            <div style="flex: 1; min-width: 140px;">
                                <span style="font-weight: 600;">${workoutLink}</span>
                                <span style="color: var(--text-dim); margin-left: 6px;">${w.date}</span>
                                ${time ? `<span style="color: var(--text-dim); margin-left: 4px;">${time}</span>` : ''}
                            </div>
                            ${distance ? `<span style="color: var(--accent); font-weight: 600;">${distance}</span>` : ''}
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 12px; color: var(--text-dim);">
                            <span>${dur}</span>
                            <span>${elev}</span>
                            <span style="color: #f59e0b; font-weight: 600;">${eff}</span>
                            <span>${heart}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Manual value editing functionality
        const manualValues = {}; // Store manual values locally
        const useManual = {}; // Track which metrics use manual values
        
        function initEditableCards() {
            document.querySelectorAll('.editable-card').forEach(card => {
                const metric = card.dataset.metric;
                const editBtn = card.querySelector('.edit-btn');
                const refreshBtn = card.querySelector('.refresh-btn');
                const valueEl = card.querySelector('.card-value');
                const inputEl = card.querySelector('.card-input');
                
                if (!editBtn || !inputEl) return;
                
                // Edit button click
                editBtn.addEventListener('click', () => {
                    const isEditing = inputEl.classList.contains('editing');
                    
                    if (isEditing) {
                        // Save the value
                        const newValue = parseFloat(inputEl.value);
                        if (!isNaN(newValue)) {
                            saveManualValue(metric, newValue);
                            useManual[metric] = true;
                            card.classList.add('manual-value');
                            updateDisplayValue(metric, newValue);
                        }
                        inputEl.classList.remove('editing');
                        valueEl.classList.remove('editing');
                        editBtn.textContent = '‚úé';
                        editBtn.title = 'Edit value';
                    } else {
                        // Start editing
                        const currentValue = extractNumericValue(valueEl.textContent);
                        inputEl.value = currentValue || '';
                        inputEl.classList.add('editing');
                        valueEl.classList.add('editing');
                        inputEl.focus();
                        editBtn.textContent = '‚úì';
                        editBtn.title = 'Save value';
                        editBtn.classList.add('active');
                    }
                });
                
                // Handle Enter key in input
                inputEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        editBtn.click();
                    } else if (e.key === 'Escape') {
                        inputEl.classList.remove('editing');
                        valueEl.classList.remove('editing');
                        editBtn.textContent = '‚úé';
                        editBtn.title = 'Edit value';
                        editBtn.classList.remove('active');
                    }
                });
                
                // Refresh button click - use automated value
                refreshBtn.addEventListener('click', () => {
                    useManual[metric] = false;
                    card.classList.remove('manual-value');
                    clearManualValue(metric);
                    fetchData(); // Refresh to get automated value
                });
            });
        }
        
        function extractNumericValue(text) {
            const match = text.match(/[\d.]+/);
            return match ? parseFloat(match[0]) : null;
        }
        
        function updateDisplayValue(metric, value) {
            const formatters = {
                sleep: v => v.toFixed(1) + 'h',
                hrv: v => Math.round(v) + ' ms',
                resting_hr: v => Math.round(v) + ' bpm',
                steps: v => Math.round(v).toLocaleString(),
                weight: v => v.toFixed(1) + ' kg',
                ctl: v => v.toFixed(1),
                atl: v => v.toFixed(1),
                tsb: v => (v >= 0 ? '+' : '') + v.toFixed(1)
            };
            
            const elementIds = {
                sleep: 'sleep-value',
                hrv: 'hrv-value',
                resting_hr: 'rhr-value',
                steps: 'steps-value',
                weight: 'weight-value',
                ctl: 'ctl-value',
                atl: 'atl-value',
                tsb: 'tsb-value'
            };
            
            const el = document.getElementById(elementIds[metric]);
            if (el && formatters[metric]) {
                el.textContent = formatters[metric](value);
            }
        }
        
        async function saveManualValue(metric, value) {
            try {
                const response = await fetch('/api/manual-values', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        metric: metric,
                        value: value,
                        date: new Date().toISOString().split('T')[0]
                    })
                });
                
                if (!response.ok) {
                    console.error('Failed to save manual value');
                }
            } catch (error) {
                console.error('Error saving manual value:', error);
            }
        }
        
        async function clearManualValue(metric) {
            try {
                const response = await fetch('/api/manual-values', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        metric: metric,
                        date: new Date().toISOString().split('T')[0]
                    })
                });
                
                if (!response.ok) {
                    console.error('Failed to clear manual value');
                }
            } catch (error) {
                console.error('Error clearing manual value:', error);
            }
        }
        
        async function loadManualValues() {
            try {
                const response = await fetch('/api/manual-values?date=' + new Date().toISOString().split('T')[0]);
                if (response.ok) {
                    const data = await response.json();
                    Object.entries(data).forEach(([metric, value]) => {
                        if (value !== null) {
                            manualValues[metric] = value;
                            useManual[metric] = true;
                            const card = document.querySelector(`.editable-card[data-metric="${metric}"]`);
                            if (card) {
                                card.classList.add('manual-value');
                            }
                            updateDisplayValue(metric, value);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading manual values:', error);
            }
        }
        
        // Initialize editable cards
        initEditableCards();
        
        // Initial load
        fetchData();
        loadManualValues();
        
        // Refresh every 5 minutes
        setInterval(fetchData, 300000);
    </script>
</body>
</html>
